#!/bin/bash

# -- CONFIG --

KEYBOARD="de-latin1-nodeadkeys"

BOOT_PART=1
SWAP_PART=2
ROOT_PART=3
HOME_PART=4

BOOT_SIZE="100MiB"
SWAP_SIZE="4GiB"
ROOT_SIZE="20GiB"


# -- SET KEYBOARD LAYOUT --

echo -e "\nKeyboard layout: $KEYBOARD"
sudo loadkeys $KEYBOARD


# -- CHECK FIRMWARE --

if [[ $(ls /sys/firmware/efi/efivars > /dev/null 2>&1) ]]; then
    echo -e "\nFirmware: UEFI"
else
    echo -e "\nFirmware: BIOS"
fi


# -- SET SYSTEM CLOCK --

timedatectl set-ntp true


# -- SHOW DISKS --

echo -e "\nBlock devices:"
lsblk


# -- SELECT DISK --

echo -e "\n"

while true
do
    read -p "Enter target block device (e.g. sda): " device

    if [[ ${#device} -ne 3 ]]; then
        echo -e "Please enter a device from the list."
        continue
    fi

    if [[ $device != sd* ]]; then
        echo -e "Please enter a device from the list."
        continue
    fi

    check=$(lsblk | grep $device)
    if [[ -z "${check// }" ]]; then 
        echo -e "Please enter a device from the list."
        continue
    fi

    break
done


# -- CONFIRMATION --

while true
do
    read -p "Are you sure you want to partition /dev/$device? (y/N) " answer

    case $answer in
        [yY]* ) break;;
        [nN]* ) exit;;
        * ) continue;;
    esac
done

# -- SHRED THE DISK --

shred -n 1 -vz "/dev/$device"


# -- PARTITION THE DISK --

echo -e "Partition /dev/$device"

fdisk /dev/$device << FDISK_CMDS
g
n
$BOOT_PART

+$BOOT_SIZE
n
$SWAP_PART

+$SWAP_SIZE
n
$ROOT_PART

+$ROOT_SIZE
n
$HOME_PART


w
FDISK_CMDS


# -- FILE SYSTEMS --

mkfs.ext4 "/dev/$device$BOOT_PART"
mkfs.ext4 "/dev/$device$ROOT_PART"
mkfs.ext4 "/dev/$device$HOME_PART"

mkswap "/dev/$device$SWAP_PART"

