#!/bin/bash


## CONFIG ##

BOOT_SIZE="200MiB"
SWAP_SIZE="4GiB"
ROOT_SIZE="20GiB"

KEYMAP="de-latin1-nodeadkeys"
TIMEZONE="Europe/Berlin"
LANG="de_DE.UTF-8"

# -- SET KEYBOARD LAYOUT --

echo -e "\nKeyboard layout: $KEYBOARD"
sudo loadkeys $KEYBOARD

## CHECK FIRMWARE ##

if [[ $(ls /sys/firmware/efi/efivars > /dev/null 2>&1) ]]; then
    echo -e "\nUEFI firmware is not supported."
    exit
fi


# -- SHOW DISKS --

echo -e "\nBlock devices:"
lsblk


# -- SELECT DISK --

echo -e "\n"

while true
do
    read -p "Enter target block device (e.g. sda): " device

    if [[ ${#device} -ne 3 ]]; then
        echo -e "Please enter a device from the list."
        continue
    fi

    if [[ $device != sd* ]]; then
        echo -e "Please enter a device from the list."
        continue
    fi

    check=$(lsblk | grep $device)
    if [[ -z "${check// }" ]]; then 
        echo -e "Please enter a device from the list."
        continue
    fi

    break
done


# -- CONFIRMATION --

while true
do
    read -p "Are you sure you want to partition /dev/$device? (y/N) " answer

    case $answer in
        [yY]* ) break;;
        [nN]* ) exit;;
        * ) continue;;
    esac
done

# -- CLEAN THE DISK --

dd if=/dev/zero of/dev/$device bs=512 count=1


# -- PARTITION THE DISK --

echo -e "Partition /dev/$device"

fdisk -w always /dev/$device << FDISK_CMDS
g
n


+$BOOT_SIZE
n


+$SWAP_SIZE
n


+$ROOT_SIZE
n



w
FDISK_CMDS


# -- FILE SYSTEMS --

mkfs.ext4 -L BOOT "/dev/$device""1"

mkswap -L SWAP "/dev/$device""2"
swapon "/dev/disk/by-label/SWAP"

mkfs.ext4 -L ROOT "/dev/$device""3"
mkfs.ext4 -L HOME "/dev/$device""4"


# -- MOUNT PARTITIONS --

mount /dev/disk/by-label/ROOT /mnt

mkdir /mnt/boot
mkdir /mnt/home

mount /dev/disk/by-label/HOME /mnt/home
mount /dev/disk/by-label/BOOT /mnt/boot


# -- INSTALL BASE SYSTEM --

basestrap /mnt base base-devel runit elogind-runit


# -- INSTALL LINUX KERNEL --

basestrap /mnt linux linux-firmware


# -- GENERATE FSTAB --

fstabgen -U /mnt >> /mnt/etc/fstab

